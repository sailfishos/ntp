Description: fix IPv6 ACL bypass
Origin: backport, http://bk1.ntp.org/ntp-stable/?PAGE=patch&REV=54922b65gDSbE4G7c3JjkuK1Tv33qQ
Origin: backport, http://bk1.ntp.org/ntp-stable/?PAGE=patch&REV=5492d2879rotbnnuVch_ZC3RAfS8AA
Origin: backport, http://bk1.ntp.org/ntp-stable/?PAGE=patch&REV=5493f333hALqPcXLR4-76bC6j-16xQ
Origin: backport, http://bk1.ntp.org/ntp-stable/?PAGE=patch&REV=5496213frLaEz5PHLZVhuYjM7Lalkw
Origin: backport, http://bk1.ntp.org/ntp-stable/ntpd/ntp_io.c?PAGE=diffs&REV=54a0f621LdfQSkkWKUKN6PaFbH25_Q
Origin: backport, http://bk1.ntp.org/ntp-stable/?PAGE=patch&REV=54c2228bpOp4_zrX9aGXdMEZJEGzkg
Bug: http://bugs.ntp.org/show_bug.cgi?id=2672

Index: ntp-4.2.4p8+dfsg/ntpd/ntp_io.c
===================================================================
--- ntp-4.2.4p8+dfsg.orig/ntpd/ntp_io.c	2015-02-06 10:48:44.561593712 -0500
+++ ntp-4.2.4p8+dfsg/ntpd/ntp_io.c	2015-02-06 11:15:25.106346591 -0500
@@ -3021,6 +3021,29 @@
 #endif
 
 	/*
+	** Bug 2672: Some OSes (MacOSX and Linux) don't block spoofed ::1
+	*/
+
+	if (AF_INET6 == itf->family) {
+		DPRINTF(2, ("Got an IPv6 packet, from <%s> (%d) to <%s> (%d)\n",
+			stoa(&rb->recv_srcadr),
+			IN6_IS_ADDR_LOOPBACK(&rb->recv_srcadr),
+			stoa(&itf->sin),
+			!IN6_IS_ADDR_LOOPBACK(&itf->sin)
+			));
+
+		if (   IN6_IS_ADDR_LOOPBACK(&rb->recv_srcadr)
+		    && !IN6_IS_ADDR_LOOPBACK(&itf->sin)
+		   ) {
+			packets_dropped++;
+			DPRINTF(2, ("DROPPING that packet\n"));
+			freerecvbuf(rb);
+			return buflen;
+		}
+		DPRINTF(2, ("processing that packet\n"));
+	}
+
+	/*
 	 * Got one.  Mark how and when it got here,
 	 * put it on the full list and do bookkeeping.
 	 */
