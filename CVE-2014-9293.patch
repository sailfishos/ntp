Description: fix weak default key in config_auth()
Author: thanks to Red Hat for original fix
Origin: backport, https://git.centos.org/blob/rpms!ntp.git/c054b85192ea340529fc9a659cac7ea6b893b50e/SOURCES!ntp-4.2.6p5-cve-2014-9293.patch
Bug: http://bugs.ntp.org/show_bug.cgi?id=2665

Index: ntp-4.2.4p8+dfsg/ntpd/ntp_config.c
===================================================================
--- ntp-4.2.4p8+dfsg.orig/ntpd/ntp_config.c	2014-12-20 06:40:19.323321647 -0500
+++ ntp-4.2.4p8+dfsg/ntpd/ntp_config.c	2014-12-20 06:41:35.307984268 -0500
@@ -1880,16 +1880,14 @@
 
 	/* if doesn't exist, make up one at random */
 	if (!authhavekey(req_keyid)) {
-		char rankey[9];
-		int j;
+		unsigned char rankey[16];
 
-		for (i = 0; i < 8; i++)
-			for (j = 1; j < 100; ++j) {
-				rankey[i] = (char) (ntp_random() & 0xff);
-				if (rankey[i] != 0) break;
-			}
-		rankey[8] = 0;
-		authusekey(req_keyid, KEY_TYPE_MD5, (u_char *)rankey);
+		if (ntp_crypto_random_buf(rankey, sizeof (rankey))) {
+			msyslog(LOG_ERR, "ntp_crypto_random_buf() failed.");
+			exit(1);
+		}
+
+		MD5auth_setkey(req_keyid, rankey, sizeof(rankey));
 		authtrust(req_keyid, 1);
 		if (!authhavekey(req_keyid)) {
 			msyslog(LOG_ERR, "getconfig: Couldn't generate a valid random key!");
Index: ntp-4.2.4p8+dfsg/ntpd/ntpd.c
===================================================================
--- ntp-4.2.4p8+dfsg.orig/ntpd/ntpd.c	2014-12-20 06:40:19.323321647 -0500
+++ ntp-4.2.4p8+dfsg/ntpd/ntpd.c	2014-12-20 06:40:19.319321612 -0500
@@ -562,6 +562,7 @@
 	get_systime(&now);
 
 	ntp_srandom((int)(now.l_i * now.l_uf));
+	ntp_crypto_srandom();
 
 #ifdef HAVE_DNSREGISTRATION
 	/* HMS: does this have to happen this early? */
